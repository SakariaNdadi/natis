{% extends "_base.html" %}
{% block title %}{{ questionnaire.title|upper }}{% endblock title %}
{% block extrajs %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
        // Get the time_left value from the template (e.g., "0:53:06.082051")
            const timeLeftString = "{{ time_left }}";

        // Parse the time_left string into hours, minutes, and seconds
            const timeParts = timeLeftString.split(":");
            let minutes = parseInt(timeParts[1], 10); // Only minutes
            let seconds = Math.floor(parseFloat(timeParts[2])); // Ignore microseconds

        // Convert total time to seconds for the countdown
            let totalSeconds = minutes * 60 + seconds;

        // Function to format time as MM:SS
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

        // Set initial timer display
            const timerDisplay = document.getElementById("timer");
            timerDisplay.textContent = formatTime(totalSeconds);

        // Update the timer every second
            const countdown = setInterval(() => {
                totalSeconds -= 1;
                if (totalSeconds < 0) {
                    clearInterval(countdown);
                    timerDisplay.textContent = "Time's up!";
                } else {
                    timerDisplay.textContent = formatTime(totalSeconds);
                }
            }, 1000);
        });
    </script>
{% endblock extrajs %}
{% block content %}
    <div class="capitalize grid grid-cols-2">
        <c-h1 title="{{ questionnaire.title }}" />

        <div>
            <p>Time Remaining: <span id="timer"></span></p>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="pb-20">
        {% csrf_token %}

        {% for field in form %}
            <div class="relative block overflow-hidden rounded-lg border border-gray-100 p-4 sm:p-6 lg:p-8">
                <span class="absolute inset-x-0 bottom-0 h-2 bg-gradient-to-r from-yellow-500 via-yellow-600 to-sky-950"></span>

                <div class="sm:flex sm:justify-between sm:gap-4">
                    <div class="text-lg font-bold sm:text-xl">
                        {{ field.label }}
                    </div>
                </div>

                <div class="mt-4 capitalize">
                    <p class="text-pretty text-sm text-gray-500">
                        {{ field }}
                    </p>
                </div>
            </div>
            <br>
        {% endfor %}

        <c-button type="submit" label="Submit" />
    </form>

{% endblock %}


{% block scripts %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const timeLeftString = "{{ time_left }}";
            const examSessionId = "{{ exam_session.id }}"; // Pass the session ID from the template
            const timeParts = timeLeftString.split(":");
            let minutes = parseInt(timeParts[1], 10);
            let seconds = Math.floor(parseFloat(timeParts[2]));

            let totalSeconds = minutes * 60 + seconds;

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            const timerDisplay = document.getElementById("timer");
            timerDisplay.textContent = formatTime(totalSeconds);

            const countdown = setInterval(() => {
                totalSeconds -= 1;
                if (totalSeconds < 0) {
                    clearInterval(countdown);
                    timerDisplay.textContent = "Time's up!";

                // Make an AJAX request to mark the exam complete
                    fetch(`/exam/mark-exam-complete/${examSessionId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}', // Include CSRF token for security
                            'Content-Type': 'application/json',
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url; // Redirect to the exam result page
                            } else {
                                console.error('Failed to redirect: ', data.error);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                } else {
                    timerDisplay.textContent = formatTime(totalSeconds);
                }
            }, 1000);
        });
    </script>

{% endblock scripts %}